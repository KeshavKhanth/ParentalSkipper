<div id="ParentalSkipperConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox,emby-linkbutton">
    <div data-role="content">
        <div class="content-primary">
            <h1>Parental Skipper Configuration</h1>

            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <button is="emby-button" type="button" class="raised" id="tabManage" style="background: #00a4dc;">Manage Scenes</button>
                <button is="emby-button" type="button" class="raised" id="tabConfigured" style="background: #333;">My Configured Items</button>
            </div>
            
            <!-- Manage Section -->
            <div id="manageSection" class="verticalSection">
                <h2>Manage Restricted Scenes</h2>
                <div class="inputContainer" style="position: relative;">
                    <label class="inputLabel" for="txtSearch">Search Movie / Series</label>
                    <input is="emby-input" type="text" id="txtSearch" placeholder="Start typing to search..." autocomplete="off" />
                    <div id="searchSuggestions" style="display:none; position:absolute; top:100%; left:0; right:0; background:#1a1a1a; border:1px solid #444; border-radius:4px; max-height:300px; overflow-y:auto; z-index:1000;"></div>
                </div>

                <!-- Movies Section -->
                <div id="moviesSection" style="display:none; margin-top: 20px;">
                    <h3>ðŸŽ¬ Movies</h3>
                    <div id="moviesList" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
                </div>

                <!-- Series Section -->
                <div id="seriesSection" style="display:none; margin-top: 20px;">
                    <h3>ðŸ“º Series</h3>
                    <div id="seriesList" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
                    
                    <div id="seriesSelectors" style="display:none; margin-top:15px; padding:15px; background:#1a1a1a; border-radius:8px;">
                        <h4 id="selectedSeriesName" style="margin-bottom:15px;"></h4>
                        <div style="display:flex; gap:15px; flex-wrap:wrap;">
                            <div class="selectContainer" style="min-width:150px;">
                                <label class="selectLabel" for="selectSeason">Season</label>
                                <select is="emby-select" id="selectSeason" class="emby-select">
                                    <option value="">Select Season</option>
                                </select>
                            </div>
                            <div class="selectContainer" style="min-width:250px;">
                                <label class="selectLabel" for="selectEpisode">Episode</label>
                                <select is="emby-select" id="selectEpisode" class="emby-select" disabled>
                                    <option value="">Select Episode</option>
                                </select>
                            </div>
                            <button is="emby-button" type="button" class="raised" id="btnSelectEpisode" disabled style="align-self:flex-end;">Edit Segments</button>
                        </div>
                    </div>
                </div>

                <!-- Segment Editor -->
                <div id="editorSection" style="display:none; margin-top: 30px; border-top: 1px solid #444; padding-top: 20px;">
                    <h3 id="selectedItemTitle"></h3>
                    <input type="hidden" id="selectedItemId" />

                    <h4>Existing Segments</h4>
                    <div id="noSegmentsMsg" style="color:#888; font-style:italic; display:none;">No segments defined yet.</div>
                    <table id="segmentsTable" class="tbl" style="width: 100%; text-align: left;">
                        <thead>
                            <tr>
                                <th>Start</th>
                                <th>End</th>
                                <th>Reason</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <h4>Add New Segment</h4>
                    <div style="display:flex; gap:10px; align-items: flex-end; flex-wrap: wrap;">
                        <div class="inputContainer">
                            <label class="inputLabel" for="txtStart">Start Time (HH:MM:SS)</label>
                            <input is="emby-input" type="text" id="txtStart" placeholder="00:15:30" />
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel" for="txtEnd">End Time (HH:MM:SS)</label>
                            <input is="emby-input" type="text" id="txtEnd" placeholder="00:16:45" />
                        </div>
                        <div class="inputContainer" style="flex-grow:1; min-width:200px;">
                            <label class="inputLabel" for="txtReason">Reason (optional)</label>
                            <input is="emby-input" type="text" id="txtReason" placeholder="e.g., Inappropriate scene" />
                        </div>
                        <button is="emby-button" type="button" class="raised" id="btnAddSegment">Add Segment</button>
                    </div>
                </div>
            </div>

            <!-- Configured Items Section -->
            <div id="configuredSection" class="verticalSection" style="display: none;">
                 <h2>My Configured Items</h2>
                 <p style="color: #ccc; margin-bottom: 20px;">Items with active skip segments.</p>
                 <div id="loadingConfigured" style="display: none;">Loading...</div>
                 <!-- Grid Layout -->
                 <div id="configuredList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;"></div>

                 <!-- Pagination -->
                 <div id="paginationControls" style="display: none; justify-content: center; align-items: center; margin-top: 20px; gap: 15px;">
                     <button is="emby-button" type="button" class="raised" id="btnPrevPage">Previous</button>
                     <span id="pageIndicator" style="font-weight: bold;">Page 1</span>
                     <button is="emby-button" type="button" class="raised" id="btnNextPage">Next</button>
                 </div>
            </div>
            
            <div class="verticalSection" style="margin-top:30px;">
                <h2>Client Script Status</h2>
                <div style="padding:15px; background:#1a1a1a; border-radius:8px;">
                    <p><strong>Script Endpoint:</strong> <code>/ParentalSkipper/ClientScript</code></p>
                    <p style="margin-top:10px;"><strong>Installation Options:</strong></p>
                    <ol style="margin-left:20px; line-height:1.8;">
                        <li><strong>Recommended:</strong> Install <a href="https://github.com/IAmParadox27/jellyfin-plugin-file-transformation" target="_blank" style="color:#00a4dc;">File Transformation Plugin</a> for automatic script injection.</li>
                        <li><strong>Manual:</strong> Add to your Jellyfin web client's <code>index.html</code>:<br/>
                            <code style="display:block; margin-top:5px; padding:10px; background:#333; border-radius:4px;">&lt;script src="/ParentalSkipper/ClientScript"&gt;&lt;/script&gt;</code>
                        </li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        (function () {
            var pluginId = "a741481e-3151-4ad9-968b-577317731032";
            var searchTimeout = null;
            var currentSeriesId = null;
            var seasonsData = {};
            var episodesData = {};
            var editingSegmentId = null; // Track if we are editing a segment

            // Pagination state
            var currentPage = 1;
            var itemsPerPage = 15;
            // For grouping, we need to process ALL configured IDs first to group episodes into Series.
            // So logic: Fetch All Configured Segments -> Fetch Metadata for ALL IDs (in chunks if needed) -> Group locally -> Then Paginate Groups.
            // This is safer for "Grouping by Series".
            var allDisplayGroups = []; // Array of { Type: 'Movie'|'Series', Name: '', Year: '', Segments: [], SeriesId: '', EpisodeDetails: [] }
            var segmentsMapGlobal = {};

            function getApiClient() {
                return window.ApiClient;
            }

            // Time conversion utilities
            function timeToSeconds(timeStr) {
                if (!timeStr) return null;
                var parts = timeStr.trim().split(':');
                if (parts.length !== 3) return null;
                var hours = parseInt(parts[0], 10);
                var minutes = parseInt(parts[1], 10);
                var seconds = parseFloat(parts[2]);
                if (isNaN(hours) || isNaN(minutes) || isNaN(seconds)) return null;
                if (minutes >= 60 || seconds >= 60) return null;
                return hours * 3600 + minutes * 60 + seconds;
            }

            function secondsToTime(totalSeconds) {
                var h = Math.floor(totalSeconds / 3600);
                var m = Math.floor((totalSeconds % 3600) / 60);
                var s = Math.floor(totalSeconds % 60);
                return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
            }

            // --- API Wrappers ---
            function loadSegments(itemId) {
                var apiClient = getApiClient();
                var url = apiClient.serverAddress() + '/ParentalSkipper/Segments/' + itemId;
                return fetchWithAuth(url, 'GET').then(function(response) {
                    return response.json();
                });
            }

            function loadAllSegments() {
                var apiClient = getApiClient();
                var url = apiClient.serverAddress() + '/ParentalSkipper/Segments';
                return fetchWithAuth(url, 'GET').then(function(response) {
                    return response.json();
                });
            }

            function addSegment(itemId, start, end, reason) {
                var apiClient = getApiClient();
                var url = apiClient.serverAddress() + '/ParentalSkipper/Segments';
                var body = JSON.stringify({
                    ItemId: itemId,
                    Start: start,
                    End: end,
                    Reason: reason || ''
                });
                return fetchWithAuth(url, 'POST', body);
            }

            function deleteSegment(id) {
                var apiClient = getApiClient();
                var url = apiClient.serverAddress() + '/ParentalSkipper/Segments/' + id;
                return fetchWithAuth(url, 'DELETE');
            }

            function fetchWithAuth(url, method, body) {
                var apiClient = getApiClient();
                var reqInit = {
                    method: method,
                    headers: {
                        'Authorization': 'MediaBrowser Token="' + apiClient.accessToken() + '"'
                    }
                };

                if (method === 'POST' && body) {
                    reqInit.headers['Content-Type'] = 'application/json';
                    reqInit.body = body;
                }

                return fetch(url, reqInit);
            }

            // --- Search Functions (Moved up for scope safety) ---
            function renderMovies(movies) {
                var container = document.querySelector('#moviesList');
                container.innerHTML = '';

                if (!movies || movies.length === 0) {
                    document.querySelector('#moviesSection').style.display = 'none';
                    return;
                }

                document.querySelector('#moviesSection').style.display = 'block';

                movies.forEach(function(movie) {
                    var btn = document.createElement('button');
                    btn.setAttribute('is', 'emby-button');
                    btn.className = 'raised';
                    btn.style.cssText = 'margin:5px; padding:10px 15px;';
                    btn.innerHTML = movie.Name + (movie.ProductionYear ? ' <span style="color:#888;">(' + movie.ProductionYear + ')</span>' : '');
                    btn.addEventListener('click', function() {
                        selectItem(movie.Id, movie.Name, 'Movie');
                    });
                    container.appendChild(btn);
                });
            }

            function renderSeries(seriesList) {
                var container = document.querySelector('#seriesList');
                container.innerHTML = '';

                if (!seriesList || seriesList.length === 0) {
                    document.querySelector('#seriesSection').style.display = 'none';
                    return;
                }

                document.querySelector('#seriesSection').style.display = 'block';
                document.querySelector('#seriesSelectors').style.display = 'none';

                seriesList.forEach(function(series) {
                    var btn = document.createElement('button');
                    btn.setAttribute('is', 'emby-button');
                    btn.className = 'raised';
                    btn.style.cssText = 'margin:5px; padding:10px 15px;';
                    btn.innerHTML = series.Name + (series.ProductionYear ? ' <span style="color:#888;">(' + series.ProductionYear + ')</span>' : '');
                    btn.addEventListener('click', function() {
                        selectSeriesItem(series.Id, series.Name);
                    });
                    container.appendChild(btn);
                });
            }

            function renderSuggestions(movies, series) {
                var container = document.querySelector('#searchSuggestions');
                container.innerHTML = '';

                if ((!movies || movies.length === 0) && (!series || series.length === 0)) {
                    container.style.display = 'none';
                    return;
                }

                if (movies && movies.length > 0) {
                    var movieHeader = document.createElement('div');
                    movieHeader.style.cssText = 'padding:8px 12px; color:#888; font-size:12px; border-bottom:1px solid #333;';
                    movieHeader.textContent = 'ðŸŽ¬ MOVIES';
                    container.appendChild(movieHeader);

                    movies.slice(0, 5).forEach(function(movie) {
                        var item = document.createElement('div');
                        item.style.cssText = 'padding:10px 12px; cursor:pointer; border-bottom:1px solid #333;';
                        item.textContent = movie.Name + (movie.ProductionYear ? ' (' + movie.ProductionYear + ')' : '');
                        item.addEventListener('mouseenter', function() { this.style.background = '#333'; });
                        item.addEventListener('mouseleave', function() { this.style.background = 'transparent'; });
                        item.addEventListener('click', function() {
                            container.style.display = 'none';
                            selectItem(movie.Id, movie.Name, 'Movie');
                        });
                        container.appendChild(item);
                    });
                }

                if (series && series.length > 0) {
                    var seriesHeader = document.createElement('div');
                    seriesHeader.style.cssText = 'padding:8px 12px; color:#888; font-size:12px; border-bottom:1px solid #333;';
                    seriesHeader.textContent = 'ðŸ“º SERIES';
                    container.appendChild(seriesHeader);

                    series.slice(0, 5).forEach(function(show) {
                        var item = document.createElement('div');
                        item.style.cssText = 'padding:10px 12px; cursor:pointer; border-bottom:1px solid #333;';
                        item.textContent = show.Name + (show.ProductionYear ? ' (' + show.ProductionYear + ')' : '');
                        item.addEventListener('mouseenter', function() { this.style.background = '#333'; });
                        item.addEventListener('mouseleave', function() { this.style.background = 'transparent'; });
                        item.addEventListener('click', function() {
                            container.style.display = 'none';
                            selectSeriesItem(show.Id, show.Name);
                        });
                        container.appendChild(item);
                    });
                }

                container.style.display = 'block';
            }

            function searchMovies(query) {
                var apiClient = getApiClient();
                return apiClient.getItems(apiClient.getCurrentUserId(), {
                    SearchTerm: query,
                    IncludeItemTypes: "Movie",
                    Limit: 20,
                    Recursive: true,
                    SortBy: "SortName"
                });
            }

            function searchSeries(query) {
                var apiClient = getApiClient();
                return apiClient.getItems(apiClient.getCurrentUserId(), {
                    SearchTerm: query,
                    IncludeItemTypes: "Series",
                    Limit: 20,
                    Recursive: true,
                    SortBy: "SortName"
                });
            }

            function performSearch(query) {
                if (!query || query.length < 2) {
                    document.querySelector('#moviesSection').style.display = 'none';
                    document.querySelector('#seriesSection').style.display = 'none';
                    document.querySelector('#searchSuggestions').style.display = 'none';
                    return;
                }

                Promise.all([searchMovies(query), searchSeries(query)]).then(function(results) {
                    var movies = results[0].Items;
                    var series = results[1].Items;
                    renderMovies(movies);
                    renderSeries(series);
                    renderSuggestions(movies, series);
                });
            }

            // --- Selection Logic ---
            function getSeasons(seriesId) {
                var apiClient = getApiClient();
                return apiClient.getItems(apiClient.getCurrentUserId(), {
                    ParentId: seriesId,
                    IncludeItemTypes: "Season",
                    SortBy: "SortName"
                });
            }

            function getEpisodes(seasonId) {
                var apiClient = getApiClient();
                return apiClient.getItems(apiClient.getCurrentUserId(), {
                    ParentId: seasonId,
                    IncludeItemTypes: "Episode",
                    SortBy: "IndexNumber"
                });
            }

            function selectSeriesItem(seriesId, seriesName) {
                currentSeriesId = seriesId;
                document.querySelector('#selectedSeriesName').textContent = 'ðŸ“º ' + seriesName;
                document.querySelector('#seriesSelectors').style.display = 'block';
                document.querySelector('#editorSection').style.display = 'none';

                var seasonSelect = document.querySelector('#selectSeason');
                var episodeSelect = document.querySelector('#selectEpisode');
                var btnSelect = document.querySelector('#btnSelectEpisode');

                seasonSelect.innerHTML = '<option value="">Loading seasons...</option>';
                episodeSelect.innerHTML = '<option value="">Select Episode</option>';
                episodeSelect.disabled = true;
                btnSelect.disabled = true;

                getSeasons(seriesId).then(function(result) {
                    seasonSelect.innerHTML = '<option value="">Select Season</option>';
                    seasonsData = {};

                    if (result.Items.length === 0) {
                        seasonSelect.innerHTML = '<option value="">No seasons found</option>';
                        return;
                    }

                    result.Items.forEach(function(season) {
                        seasonsData[season.Id] = season;
                        var opt = document.createElement('option');
                        opt.value = season.Id;
                        opt.textContent = season.Name || ('Season ' + season.IndexNumber);
                        seasonSelect.appendChild(opt);
                    });
                });
            }

            function onSeasonChange(seasonId) {
                var episodeSelect = document.querySelector('#selectEpisode');
                var btnSelect = document.querySelector('#btnSelectEpisode');

                if (!seasonId) {
                    episodeSelect.innerHTML = '<option value="">Select Episode</option>';
                    episodeSelect.disabled = true;
                    btnSelect.disabled = true;
                    return;
                }

                episodeSelect.innerHTML = '<option value="">Loading episodes...</option>';
                episodeSelect.disabled = true;

                getEpisodes(seasonId).then(function(result) {
                    episodeSelect.innerHTML = '<option value="">Select Episode</option>';
                    episodeSelect.disabled = false;
                    episodesData = {};

                    if (result.Items.length === 0) {
                        episodeSelect.innerHTML = '<option value="">No episodes found</option>';
                        episodeSelect.disabled = true;
                        return;
                    }

                    result.Items.forEach(function(episode) {
                        episodesData[episode.Id] = episode;
                        var opt = document.createElement('option');
                        opt.value = episode.Id;
                        var epNum = episode.IndexNumber ? ('E' + episode.IndexNumber + ' - ') : '';
                        opt.textContent = epNum + episode.Name;
                        episodeSelect.appendChild(opt);
                    });
                });
            }

            function editSegment(segment) {
                document.querySelector('#txtStart').value = secondsToTime(segment.Start);
                document.querySelector('#txtEnd').value = secondsToTime(segment.End);
                document.querySelector('#txtReason').value = segment.Reason || '';

                editingSegmentId = segment.Id;

                var btn = document.querySelector('#btnAddSegment');
                btn.textContent = 'Update Segment';
                btn.style.background = '#eab308';

                document.querySelector('#txtStart').focus();
            }

            function resetEditState() {
                editingSegmentId = null;
                var btn = document.querySelector('#btnAddSegment');
                btn.textContent = 'Add Segment';
                btn.style.background = '';

                document.querySelector('#txtStart').value = '';
                document.querySelector('#txtEnd').value = '';
                document.querySelector('#txtReason').value = '';
            }

            function renderSegments(segments) {
                var tbody = document.querySelector('#segmentsTable tbody');
                var noMsg = document.querySelector('#noSegmentsMsg');
                tbody.innerHTML = '';

                if (!segments || segments.length === 0) {
                    noMsg.style.display = 'block';
                    document.querySelector('#segmentsTable').style.display = 'none';
                    return;
                }
                
                noMsg.style.display = 'none';
                document.querySelector('#segmentsTable').style.display = 'table';

                segments.forEach(function(s) {
                    var tr = document.createElement('tr');

                    var tdStart = document.createElement('td');
                    tdStart.textContent = secondsToTime(s.Start);

                    var tdEnd = document.createElement('td');
                    tdEnd.textContent = secondsToTime(s.End);

                    var tdReason = document.createElement('td');
                    tdReason.innerHTML = s.Reason || '<em style="color:#888;">-</em>';

                    var tdActions = document.createElement('td');

                    var btnEdit = document.createElement('button');
                    btnEdit.type = 'button';
                    btnEdit.className = 'fab mini';
                    btnEdit.style.cssText = 'background: transparent; color: inherit; margin-right: 5px;';
                    btnEdit.title = 'Edit';
                    btnEdit.innerHTML = '&#9998;';
                    btnEdit.onclick = function() { editSegment(s); };

                    var btnDelete = document.createElement('button');
                    btnDelete.setAttribute('is', 'emby-button');
                    btnDelete.type = 'button';
                    btnDelete.className = 'raised button-delete';
                    btnDelete.setAttribute('data-id', s.Id);
                    btnDelete.textContent = 'Delete';

                    tdActions.appendChild(btnEdit);
                    tdActions.appendChild(btnDelete);

                    tr.appendChild(tdStart);
                    tr.appendChild(tdEnd);
                    tr.appendChild(tdReason);
                    tr.appendChild(tdActions);

                    tbody.appendChild(tr);
                });

                tbody.querySelectorAll('.button-delete').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var segId = this.getAttribute('data-id');
                        if (confirm('Delete this segment?')) {
                            deleteSegment(segId).then(function() {
                                var itemId = document.querySelector('#selectedItemId').value;
                                loadSegments(itemId).then(renderSegments);
                                if (editingSegmentId == segId) resetEditState();
                            });
                        }
                    });
                });
            }

            function selectItem(itemId, itemName, itemType) {
                document.querySelector('#selectedItemId').value = itemId;
                var typeLabel = itemType === 'Movie' ? 'ðŸŽ¬' : 'ðŸ“º';
                document.querySelector('#selectedItemTitle').textContent = typeLabel + ' Editing: ' + itemName;
                document.querySelector('#editorSection').style.display = 'block';
                document.querySelector('#editorSection').scrollIntoView({ behavior: 'smooth' });
                resetEditState();
                loadSegments(itemId).then(renderSegments);
            }

            // --- Pagination & Grouping Logic ---
            function loadPage(page) {
                currentPage = page;
                var container = document.querySelector('#configuredList');
                container.innerHTML = '';

                var start = (page - 1) * itemsPerPage;
                var end = start + itemsPerPage;
                var pageItems = allDisplayGroups.slice(start, end);

                if (pageItems.length === 0 && page === 1) {
                    container.innerHTML = '<div style="padding: 20px; color: #888;">No items configured.</div>';
                    return;
                }

                pageItems.forEach(function(group) {
                    var card = document.createElement('div');
                    card.style.cssText = 'background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; display: flex; flex-direction: column;';

                    var header = document.createElement('div');
                    header.style.cssText = 'display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;';

                    var headerHtml = '<div>';
                    // Show Series Name or Movie Name
                    var typeIcon = group.Type === 'Series' ? 'ðŸ“º' : 'ðŸŽ¬';
                    headerHtml += '<h3 style="margin: 0; font-size: 1.1em;">' + typeIcon + ' ' + group.Name + '</h3>';
                    headerHtml += '<div style="font-size: 0.85em; color: #888;">' + (group.Year || '') + '</div>';
                    headerHtml += '</div>';

                    // Count Logic
                    var count = 0;
                    if (group.Type === 'Movie') {
                        count = group.Segments.length;
                    } else {
                        // For series, sum segments across episodes
                        count = group.EpisodeDetails.reduce(function(acc, ep) { return acc + ep.Segments.length; }, 0);
                    }

                    headerHtml += '<div style="font-size: 0.9em; background: #333; padding: 2px 6px; border-radius: 4px;">' + count + ' Segments</div>';
                    header.innerHTML = headerHtml;

                    var details = document.createElement('div');
                    details.style.cssText = 'display: none; margin-top: auto; border-top: 1px solid #444; padding-top: 10px;';

                    // Render Details based on Type
                    if (group.Type === 'Movie') {
                        var table = '<table class="tbl" style="width: 100%; text-align: left; font-size: 0.9em;"><thead><tr><th>Start</th><th>End</th></tr></thead><tbody>';
                        group.Segments.forEach(function(s) {
                            table += '<tr><td>' + secondsToTime(s.Start) + '</td><td>' + secondsToTime(s.End) + '</td></tr>';
                        });
                        table += '</tbody></table>';
                        details.innerHTML = table;

                        var editBtn = document.createElement('button');
                        editBtn.setAttribute('is', 'emby-button');
                        editBtn.className = 'raised';
                        editBtn.style.cssText = 'margin-top: 10px; width: 100%; background: #00a4dc; font-size: 0.9em; padding: 5px;';
                        editBtn.textContent = 'Edit Movie';
                        editBtn.onclick = function() {
                            document.querySelector('#tabManage').click();
                            selectItem(group.Id, group.Name, 'Movie');
                        };
                        details.appendChild(editBtn);
                    } else {
                        // Series: List episodes
                        group.EpisodeDetails.forEach(function(ep) {
                            var epRow = document.createElement('div');
                            epRow.style.cssText = 'margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #333;';
                            epRow.innerHTML = '<div style="font-weight:bold; font-size:0.95em;">' + ep.EpisodeTitle + '</div>';

                            var table = '<table class="tbl" style="width: 100%; text-align: left; font-size: 0.85em; margin-top: 4px; color: #ccc;"><tbody>';
                            ep.Segments.forEach(function(s) {
                                table += '<tr><td style="width: 60px;">' + secondsToTime(s.Start) + ' - ' + secondsToTime(s.End) + '</td><td>' + (s.Reason||'') + '</td></tr>';
                            });
                            table += '</tbody></table>';
                            epRow.innerHTML += table;

                            var editEpBtn = document.createElement('button');
                            editEpBtn.textContent = 'Edit';
                            editEpBtn.style.cssText = 'background:none; border:none; color: #00a4dc; cursor: pointer; font-size: 0.8em; padding: 0; margin-top: 2px;';
                            editEpBtn.onclick = function() {
                                document.querySelector('#tabManage').click();
                                // We need season info to properly select, but we can jump to editing by ID if we skip "selectSeriesItem"
                                // Just call selectItem directly with Episode ID
                                selectItem(ep.Id, group.Name + ' - ' + ep.EpisodeTitle, 'Episode');
                            };
                            epRow.appendChild(editEpBtn);

                            details.appendChild(epRow);
                        });
                    }

                    var footer = document.createElement('div');
                    footer.style.cssText = 'margin-top: 10px; text-align: center; cursor: pointer; color: #ccc; font-size: 0.9em;';
                    footer.textContent = 'Show Details';
                    footer.onclick = function() {
                        var isHidden = details.style.display === 'none';
                        details.style.display = isHidden ? 'block' : 'none';
                        footer.textContent = isHidden ? 'Hide Details' : 'Show Details';
                    };

                    card.appendChild(header);
                    card.appendChild(details);
                    card.appendChild(footer);
                    container.appendChild(card);
                });

                updatePaginationControls();
            }

            function updatePaginationControls() {
                var container = document.querySelector('#paginationControls');
                var btnPrev = document.querySelector('#btnPrevPage');
                var btnNext = document.querySelector('#btnNextPage');
                var indicator = document.querySelector('#pageIndicator');

                var totalPages = Math.ceil(allDisplayGroups.length / itemsPerPage);

                if (totalPages <= 1) {
                    container.style.display = 'none';
                    return;
                }
                
                container.style.display = 'flex';
                indicator.textContent = 'Page ' + currentPage + ' of ' + totalPages;

                btnPrev.disabled = currentPage === 1;
                btnNext.disabled = currentPage === totalPages;
            }

            function renderConfiguredItems() {
                var container = document.querySelector('#configuredList');
                var loader = document.querySelector('#loadingConfigured');

                container.innerHTML = '';
                loader.style.display = 'block';

                loadAllSegments().then(function(groupedSegments) {
                    var rawIds = Object.keys(groupedSegments);
                    if (rawIds.length === 0) {
                        loader.style.display = 'none';
                        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No items configured yet.</div>';
                        return;
                    }

                    segmentsMapGlobal = {};
                    rawIds.forEach(function(key) {
                        var normalizedKey = key.replace(/-/g, '').toLowerCase();
                        segmentsMapGlobal[normalizedKey] = groupedSegments[key];
                    });
                    
                    // Fetch ALL metadata to group properly (Might be heavy for huge libs, but necessary for grouping by series)
                    // Optimization: We could fetch in batches, but grouping requires knowing series context.
                    // Let's assume reasonable size for now.
                    var apiClient = getApiClient();
                    apiClient.getItems(apiClient.getCurrentUserId(), {
                        Ids: rawIds.join(','),
                        Recursive: true,
                        Fields: "ParentId,SeriesName,SeriesId,SeasonName,IndexNumber,ParentIndexNumber"
                    }).then(function(result) {
                        loader.style.display = 'none';
                        var items = result.Items;

                        if (!items || items.length === 0) {
                             container.innerHTML = '<div style="color: #ccc;">Items found in DB but not in Library.</div>';
                             return;
                        }

                        // Process and Group
                        var groups = {}; // Key: SeriesId (for episodes) or Id (for movies)

                        items.forEach(function(item) {
                            var itemIdLower = item.Id.replace(/-/g, '').toLowerCase();
                            var itemSegments = segmentsMapGlobal[itemIdLower] || [];

                            if (item.Type === 'Episode') {
                                // Group by Series
                                var seriesId = item.SeriesId || item.ParentId; // Fallback
                                var seriesName = item.SeriesName || 'Unknown Series';

                                if (!groups[seriesId]) {
                                    groups[seriesId] = {
                                        Id: seriesId,
                                        Type: 'Series',
                                        Name: seriesName,
                                        Year: '', // Series Year difficult to get from Episode without extra fetch
                                        EpisodeDetails: []
                                    };
                                }

                                // Format Episode Title: S01E05
                                var sNum = item.ParentIndexNumber != null ? item.ParentIndexNumber : '?';
                                var eNum = item.IndexNumber != null ? item.IndexNumber : '?';
                                var epTitle = 'S' + String(sNum).padStart(2,'0') + ' E' + String(eNum).padStart(2,'0') + ' - ' + item.Name;

                                groups[seriesId].EpisodeDetails.push({
                                    Id: item.Id,
                                    EpisodeTitle: epTitle,
                                    Segments: itemSegments
                                });

                            } else {
                                // Movie or other
                                groups[item.Id] = {
                                    Id: item.Id,
                                    Type: 'Movie',
                                    Name: item.Name,
                                    Year: item.ProductionYear,
                                    Segments: itemSegments
                                };
                            }
                        });

                        // Convert map to array and sort
                        allDisplayGroups = Object.values(groups);
                        allDisplayGroups.sort(function(a, b) {
                            return a.Name.localeCompare(b.Name);
                        });

                        // Sort episodes inside series
                        allDisplayGroups.forEach(function(g) {
                            if (g.Type === 'Series') {
                                g.EpisodeDetails.sort(function(a, b) {
                                    return a.EpisodeTitle.localeCompare(b.EpisodeTitle);
                                });
                            }
                        });

                        loadPage(1);

                    });
                }).catch(function(err) {
                    console.error(err);
                    loader.style.display = 'none';
                    container.innerHTML = '<div style="color: red;">Error loading items. Check console.</div>';
                });
            }

            // Page initialization
            document.querySelector('#ParentalSkipperConfigPage').addEventListener('pageshow', function () {
                var page = this;
                if (page.getAttribute('data-listeners-attached') === 'true') return;
                page.setAttribute('data-listeners-attached', 'true');

                var txtSearch = page.querySelector('#txtSearch');
                var selectSeason = page.querySelector('#selectSeason');
                var selectEpisode = page.querySelector('#selectEpisode');
                var btnSelectEpisode = page.querySelector('#btnSelectEpisode');

                var tabManage = page.querySelector('#tabManage');
                var tabConfigured = page.querySelector('#tabConfigured');
                var sectionManage = page.querySelector('#manageSection');
                var sectionConfigured = page.querySelector('#configuredSection');

                tabManage.addEventListener('click', function() {
                    tabManage.style.background = '#00a4dc';
                    tabConfigured.style.background = '#333';
                    sectionManage.style.display = 'block';
                    sectionConfigured.style.display = 'none';
                    resetEditState();
                });

                tabConfigured.addEventListener('click', function() {
                    tabConfigured.style.background = '#00a4dc';
                    tabManage.style.background = '#333';
                    sectionManage.style.display = 'none';
                    sectionConfigured.style.display = 'block';
                    renderConfiguredItems();
                });

                page.querySelector('#btnPrevPage').addEventListener('click', function() {
                    if (currentPage > 1) loadPage(currentPage - 1);
                });

                page.querySelector('#btnNextPage').addEventListener('click', function() {
                    var totalPages = Math.ceil(allDisplayGroups.length / itemsPerPage);
                    if (currentPage < totalPages) loadPage(currentPage + 1);
                });

                txtSearch.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    var query = this.value;
                    searchTimeout = setTimeout(function() {
                        performSearch(query);
                    }, 300);
                });

                document.addEventListener('click', function(e) {
                    var suggestions = page.querySelector('#searchSuggestions');
                    if (!txtSearch.contains(e.target) && !suggestions.contains(e.target)) {
                        suggestions.style.display = 'none';
                    }
                });

                txtSearch.addEventListener('focus', function() {
                    if (this.value.length >= 2) performSearch(this.value);
                });

                selectSeason.addEventListener('change', function() {
                    onSeasonChange(this.value);
                });

                selectEpisode.addEventListener('change', function() {
                    btnSelectEpisode.disabled = !this.value;
                });

                btnSelectEpisode.addEventListener('click', function() {
                    var episodeId = selectEpisode.value;
                    if (episodeId && episodesData[episodeId]) {
                        var episode = episodesData[episodeId];
                        var seasonName = seasonsData[selectSeason.value] ? seasonsData[selectSeason.value].Name : '';
                        var fullName = seasonName + ' - ' + episode.Name;
                        selectItem(episodeId, fullName, 'Episode');
                    }
                });

                page.querySelector('#btnAddSegment').addEventListener('click', function () {
                    var itemId = page.querySelector('#selectedItemId').value;
                    var startStr = page.querySelector('#txtStart').value;
                    var endStr = page.querySelector('#txtEnd').value;
                    var reason = page.querySelector('#txtReason').value;
                    
                    if (!itemId) { alert('Please select a movie or episode first.'); return; }
                    if (!startStr || !endStr) { alert('Please enter both Start and End times.'); return; }

                    var startSeconds = timeToSeconds(startStr);
                    var endSeconds = timeToSeconds(endStr);

                    if (startSeconds === null || endSeconds === null || startSeconds >= endSeconds) {
                        alert('Invalid time range.'); return;
                    }

                    var performAdd = function() {
                        addSegment(itemId, startSeconds, endSeconds, reason).then(function() {
                            loadSegments(itemId).then(renderSegments);
                            resetEditState();
                        }).catch(function(err) {
                            console.error(err);
                            alert('Error saving segment.');
                        });
                    };

                    if (editingSegmentId) {
                        deleteSegment(editingSegmentId).then(performAdd).catch(function(err){console.error(err); alert('Error updating.');});
                    } else {
                        performAdd();
                    }
                });
            });
        })();
    </script>
</div>
