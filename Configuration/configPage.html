<div id="ParentalSkipperConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox,emby-linkbutton">
    <div data-role="content">
        <div class="content-primary">
            <h1>Parental Skipper Configuration</h1>

            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <button is="emby-button" type="button" class="raised" id="tabManage" style="background: #00a4dc;">Manage Scenes</button>
                <button is="emby-button" type="button" class="raised" id="tabConfigured" style="background: #333;">My Configured Items</button>
            </div>
            
            <!-- Manage Section -->
            <div id="manageSection" class="verticalSection">
                <h2>Manage Restricted Scenes</h2>
                <div class="inputContainer" style="position: relative;">
                    <label class="inputLabel" for="txtSearch">Search Movie / Series</label>
                    <input is="emby-input" type="text" id="txtSearch" placeholder="Start typing to search..." autocomplete="off" />
                    <div id="searchSuggestions" style="display:none; position:absolute; top:100%; left:0; right:0; background:#1a1a1a; border:1px solid #444; border-radius:4px; max-height:300px; overflow-y:auto; z-index:1000;"></div>
                </div>

                <!-- Movies Section -->
                <div id="moviesSection" style="display:none; margin-top: 20px;">
                    <h3>ðŸŽ¬ Movies</h3>
                    <div id="moviesList" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
                </div>

                <!-- Series Section -->
                <div id="seriesSection" style="display:none; margin-top: 20px;">
                    <h3>ðŸ“º Series</h3>
                    <div id="seriesList" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
                    
                    <div id="seriesSelectors" style="display:none; margin-top:15px; padding:15px; background:#1a1a1a; border-radius:8px;">
                        <h4 id="selectedSeriesName" style="margin-bottom:15px;"></h4>
                        <div style="display:flex; gap:15px; flex-wrap:wrap;">
                            <div class="selectContainer" style="min-width:150px;">
                                <label class="selectLabel" for="selectSeason">Season</label>
                                <select is="emby-select" id="selectSeason" class="emby-select">
                                    <option value="">Select Season</option>
                                </select>
                            </div>
                            <div class="selectContainer" style="min-width:250px;">
                                <label class="selectLabel" for="selectEpisode">Episode</label>
                                <select is="emby-select" id="selectEpisode" class="emby-select" disabled>
                                    <option value="">Select Episode</option>
                                </select>
                            </div>
                            <button is="emby-button" type="button" class="raised" id="btnSelectEpisode" disabled style="align-self:flex-end;">Edit Segments</button>
                        </div>
                    </div>
                </div>

                <!-- Segment Editor -->
                <div id="editorSection" style="display:none; margin-top: 30px; border-top: 1px solid #444; padding-top: 20px;">
                    <h3 id="selectedItemTitle"></h3>
                    <input type="hidden" id="selectedItemId" />

                    <h4>Existing Segments</h4>
                    <div id="noSegmentsMsg" style="color:#888; font-style:italic; display:none;">No segments defined yet.</div>
                    <table id="segmentsTable" class="tbl" style="width: 100%; text-align: left;">
                        <thead>
                            <tr>
                                <th>Start</th>
                                <th>End</th>
                                <th>Reason</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <h4>Add New Segment</h4>
                    <div style="display:flex; gap:10px; align-items: flex-end; flex-wrap: wrap;">
                        <div class="inputContainer">
                            <label class="inputLabel" for="txtStart">Start Time (HH:MM:SS)</label>
                            <input is="emby-input" type="text" id="txtStart" placeholder="00:15:30" />
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel" for="txtEnd">End Time (HH:MM:SS)</label>
                            <input is="emby-input" type="text" id="txtEnd" placeholder="00:16:45" />
                        </div>
                        <div class="inputContainer" style="flex-grow:1; min-width:200px;">
                            <label class="inputLabel" for="txtReason">Reason (optional)</label>
                            <input is="emby-input" type="text" id="txtReason" placeholder="e.g., Inappropriate scene" />
                        </div>
                        <button is="emby-button" type="button" class="raised" id="btnAddSegment">Add Segment</button>
                    </div>
                </div>
            </div>

            <!-- Configured Items Section -->
            <div id="configuredSection" class="verticalSection" style="display: none;">
                 <h2>My Configured Items</h2>
                 <p style="color: #ccc; margin-bottom: 20px;">Items with active skip segments.</p>
                 <div id="loadingConfigured" style="display: none;">Loading...</div>
                 <div id="configuredList" style="display: flex; flex-direction: column; gap: 15px;"></div>
            </div>
            
            <div class="verticalSection" style="margin-top:30px;">
                <h2>Client Script Status</h2>
                <div style="padding:15px; background:#1a1a1a; border-radius:8px;">
                    <p><strong>Script Endpoint:</strong> <code>/ParentalSkipper/ClientScript</code></p>
                    <p style="margin-top:10px;"><strong>Installation Options:</strong></p>
                    <ol style="margin-left:20px; line-height:1.8;">
                        <li><strong>Recommended:</strong> Install <a href="https://github.com/IAmParadox27/jellyfin-plugin-file-transformation" target="_blank" style="color:#00a4dc;">File Transformation Plugin</a> for automatic script injection.</li>
                        <li><strong>Manual:</strong> Add to your Jellyfin web client's <code>index.html</code>:<br/>
                            <code style="display:block; margin-top:5px; padding:10px; background:#333; border-radius:4px;">&lt;script src="/ParentalSkipper/ClientScript"&gt;&lt;/script&gt;</code>
                        </li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        (function () {
            var pluginId = "a741481e-3151-4ad9-968b-577317731032";
            var searchTimeout = null;
            var currentSeriesId = null;
            var seasonsData = {};
            var episodesData = {};

            function getApiClient() {
                return window.ApiClient;
            }

            // Time conversion utilities
            function timeToSeconds(timeStr) {
                if (!timeStr) return null;
                var parts = timeStr.trim().split(':');
                if (parts.length !== 3) return null;
                var hours = parseInt(parts[0], 10);
                var minutes = parseInt(parts[1], 10);
                var seconds = parseFloat(parts[2]);
                if (isNaN(hours) || isNaN(minutes) || isNaN(seconds)) return null;
                if (minutes >= 60 || seconds >= 60) return null;
                return hours * 3600 + minutes * 60 + seconds;
            }

            function secondsToTime(totalSeconds) {
                var h = Math.floor(totalSeconds / 3600);
                var m = Math.floor((totalSeconds % 3600) / 60);
                var s = Math.floor(totalSeconds % 60);
                return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
            }

            // Search for Movies
            function searchMovies(query) {
                var apiClient = getApiClient();
                return apiClient.getItems(apiClient.getCurrentUserId(), {
                    SearchTerm: query,
                    IncludeItemTypes: "Movie",
                    Limit: 20,
                    Recursive: true,
                    SortBy: "SortName"
                });
            }

            // Search for Series
            function searchSeries(query) {
                var apiClient = getApiClient();
                return apiClient.getItems(apiClient.getCurrentUserId(), {
                    SearchTerm: query,
                    IncludeItemTypes: "Series",
                    Limit: 20,
                    Recursive: true,
                    SortBy: "SortName"
                });
            }

            // Get Seasons for a Series
            function getSeasons(seriesId) {
                var apiClient = getApiClient();
                return apiClient.getItems(apiClient.getCurrentUserId(), {
                    ParentId: seriesId,
                    IncludeItemTypes: "Season",
                    SortBy: "SortName"
                });
            }

            // Get Episodes for a Season
            function getEpisodes(seasonId) {
                var apiClient = getApiClient();
                return apiClient.getItems(apiClient.getCurrentUserId(), {
                    ParentId: seasonId,
                    IncludeItemTypes: "Episode",
                    SortBy: "IndexNumber"
                });
            }

            // Segment API calls
            function loadSegments(itemId) {
                var apiClient = getApiClient();
                var url = apiClient.serverAddress() + '/ParentalSkipper/Segments/' + itemId;
                return fetchWithAuth(url, 'GET').then(function(response) {
                    return response.json();
                });
            }

            function loadAllSegments() {
                var apiClient = getApiClient();
                var url = apiClient.serverAddress() + '/ParentalSkipper/Segments';
                return fetchWithAuth(url, 'GET').then(function(response) {
                    return response.json();
                });
            }

            function addSegment(itemId, start, end, reason) {
                var apiClient = getApiClient();
                var url = apiClient.serverAddress() + '/ParentalSkipper/Segments';
                var body = JSON.stringify({
                    ItemId: itemId,
                    Start: start,
                    End: end,
                    Reason: reason || ''
                });
                return fetchWithAuth(url, 'POST', body);
            }

            function deleteSegment(id) {
                var apiClient = getApiClient();
                var url = apiClient.serverAddress() + '/ParentalSkipper/Segments/' + id;
                return fetchWithAuth(url, 'DELETE');
            }

            // Make an authenticated fetch to the Jellyfin server
            function fetchWithAuth(url, method, body) {
                var apiClient = getApiClient();
                var reqInit = {
                    method: method,
                    headers: {
                        'Authorization': 'MediaBrowser Token="' + apiClient.accessToken() + '"'
                    }
                };

                if (method === 'POST' && body) {
                    reqInit.headers['Content-Type'] = 'application/json';
                    reqInit.body = body;
                }

                return fetch(url, reqInit);
            }

            // Render segments table
            function renderSegments(segments) {
                var tbody = document.querySelector('#segmentsTable tbody');
                var noMsg = document.querySelector('#noSegmentsMsg');
                tbody.innerHTML = '';
                
                if (!segments || segments.length === 0) {
                    noMsg.style.display = 'block';
                    document.querySelector('#segmentsTable').style.display = 'none';
                    return;
                }
                
                noMsg.style.display = 'none';
                document.querySelector('#segmentsTable').style.display = 'table';
                
                segments.forEach(function(s) {
                    var tr = document.createElement('tr');
                    tr.innerHTML = 
                        '<td>' + secondsToTime(s.Start) + '</td>' +
                        '<td>' + secondsToTime(s.End) + '</td>' +
                        '<td>' + (s.Reason || '<em style="color:#888;">-</em>') + '</td>' +
                        '<td><button is="emby-button" type="button" class="raised button-delete" data-id="' + s.Id + '">Delete</button></td>';
                    tbody.appendChild(tr);
                });

                // Attach delete handlers
                tbody.querySelectorAll('.button-delete').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var segId = this.getAttribute('data-id');
                        if (confirm('Delete this segment?')) {
                            deleteSegment(segId).then(function() {
                                var itemId = document.querySelector('#selectedItemId').value;
                                loadSegments(itemId).then(renderSegments);
                            });
                        }
                    });
                });
            }

            // Show editor for selected item
            function selectItem(itemId, itemName, itemType) {
                document.querySelector('#selectedItemId').value = itemId;
                var typeLabel = itemType === 'Movie' ? 'ðŸŽ¬' : 'ðŸ“º';
                document.querySelector('#selectedItemTitle').textContent = typeLabel + ' Editing: ' + itemName;
                document.querySelector('#editorSection').style.display = 'block';
                document.querySelector('#editorSection').scrollIntoView({ behavior: 'smooth' });
                loadSegments(itemId).then(renderSegments);
            }

            // Render Configured Items
            function renderConfiguredItems() {
                var container = document.querySelector('#configuredList');
                var loader = document.querySelector('#loadingConfigured');

                container.innerHTML = '';
                loader.style.display = 'block';

                loadAllSegments().then(function(groupedSegments) {
                    var itemIds = Object.keys(groupedSegments);
                    if (itemIds.length === 0) {
                        loader.style.display = 'none';
                        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No items configured yet.</div>';
                        return;
                    }

                    // Normalize Keys to lowercase for easier lookup (since we suspect ID mismatch)
                    var segmentsMap = {};
                    itemIds.forEach(function(key) {
                        segmentsMap[key.toLowerCase()] = groupedSegments[key];
                    });

                    // Fetch item details from Jellyfin
                    var apiClient = getApiClient();
                    apiClient.getItems(apiClient.getCurrentUserId(), {
                        Ids: itemIds.join(','),
                        Recursive: true
                    }).then(function(result) {
                        loader.style.display = 'none';
                        var items = result.Items;

                        if (!items || items.length === 0) {
                             container.innerHTML = '<div style="color: #ccc;">Items found in DB but not in Library (Ids might have changed?).</div>';
                             return;
                        }

                        items.forEach(function(item) {
                            var itemIdLower = item.Id.toLowerCase();
                            var itemSegments = segmentsMap[itemIdLower] || [];
                            var count = itemSegments.length;

                            var card = document.createElement('div');
                            card.style.cssText = 'background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333;';

                            var header = document.createElement('div');
                            header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; cursor: pointer;';
                            header.innerHTML = `
                                <div>
                                    <h3 style="margin: 0;">${item.Name} <span style="font-size: 0.8em; color: #888; font-weight: normal;">(${item.ProductionYear || 'Unknown'})</span></h3>
                                    <div style="font-size: 0.9em; color: #aaa; margin-top: 5px;">${count} Segment${count !== 1 ? 's' : ''}</div>
                                </div>
                                <button is="emby-button" type="button" class="raised" style="min-width: 80px;">Expand</button>
                            `;

                            var details = document.createElement('div');
                            details.style.cssText = 'display: none; margin-top: 15px; border-top: 1px solid #444; padding-top: 10px;';

                            // Build simple table for details
                            var table = '<table class="tbl" style="width: 100%; text-align: left;"><thead><tr><th>Start</th><th>End</th><th>Reason</th></tr></thead><tbody>';
                            itemSegments.forEach(function(s) {
                                table += `<tr><td>${secondsToTime(s.Start)}</td><td>${secondsToTime(s.End)}</td><td>${s.Reason || '-'}</td></tr>`;
                            });
                            table += '</tbody></table>';

                            // Edit Button
                            var editBtn = document.createElement('button');
                            editBtn.setAttribute('is', 'emby-button');
                            editBtn.className = 'raised';
                            editBtn.style.cssText = 'margin-top: 10px; width: 100%; background: #00a4dc;';
                            editBtn.textContent = 'Edit Segments';
                            editBtn.onclick = function() {
                                // Switch to manage tab
                                document.querySelector('#tabManage').click();
                                // Select this item
                                selectItem(item.Id, item.Name, item.Type);
                            };

                            details.innerHTML = table;
                            details.appendChild(editBtn);

                            header.onclick = function() {
                                var isHidden = details.style.display === 'none';
                                details.style.display = isHidden ? 'block' : 'none';
                                header.querySelector('button').textContent = isHidden ? 'Collapse' : 'Expand';
                            };

                            card.appendChild(header);
                            card.appendChild(details);
                            container.appendChild(card);
                        });
                    });
                }).catch(function(err) {
                    console.error(err);
                    loader.style.display = 'none';
                    container.innerHTML = '<div style="color: red;">Error loading items. Check console.</div>';
                });
            }

            // Render movie results
            function renderMovies(movies) {
                var container = document.querySelector('#moviesList');
                container.innerHTML = '';
                
                if (!movies || movies.length === 0) {
                    document.querySelector('#moviesSection').style.display = 'none';
                    return;
                }
                
                document.querySelector('#moviesSection').style.display = 'block';
                
                movies.forEach(function(movie) {
                    var btn = document.createElement('button');
                    btn.setAttribute('is', 'emby-button');
                    btn.className = 'raised';
                    btn.style.cssText = 'margin:5px; padding:10px 15px;';
                    btn.innerHTML = movie.Name + (movie.ProductionYear ? ' <span style="color:#888;">(' + movie.ProductionYear + ')</span>' : '');
                    btn.addEventListener('click', function() {
                        selectItem(movie.Id, movie.Name, 'Movie');
                    });
                    container.appendChild(btn);
                });
            }

            // Render series results
            function renderSeries(seriesList) {
                var container = document.querySelector('#seriesList');
                container.innerHTML = '';
                
                if (!seriesList || seriesList.length === 0) {
                    document.querySelector('#seriesSection').style.display = 'none';
                    return;
                }
                
                document.querySelector('#seriesSection').style.display = 'block';
                document.querySelector('#seriesSelectors').style.display = 'none';
                
                seriesList.forEach(function(series) {
                    var btn = document.createElement('button');
                    btn.setAttribute('is', 'emby-button');
                    btn.className = 'raised';
                    btn.style.cssText = 'margin:5px; padding:10px 15px;';
                    btn.innerHTML = series.Name + (series.ProductionYear ? ' <span style="color:#888;">(' + series.ProductionYear + ')</span>' : '');
                    btn.addEventListener('click', function() {
                        selectSeriesItem(series.Id, series.Name);
                    });
                    container.appendChild(btn);
                });
            }

            // Select a series and load its seasons
            function selectSeriesItem(seriesId, seriesName) {
                currentSeriesId = seriesId;
                document.querySelector('#selectedSeriesName').textContent = 'ðŸ“º ' + seriesName;
                document.querySelector('#seriesSelectors').style.display = 'block';
                document.querySelector('#editorSection').style.display = 'none';
                
                var seasonSelect = document.querySelector('#selectSeason');
                var episodeSelect = document.querySelector('#selectEpisode');
                var btnSelect = document.querySelector('#btnSelectEpisode');
                
                seasonSelect.innerHTML = '<option value="">Loading seasons...</option>';
                episodeSelect.innerHTML = '<option value="">Select Episode</option>';
                episodeSelect.disabled = true;
                btnSelect.disabled = true;
                
                getSeasons(seriesId).then(function(result) {
                    seasonSelect.innerHTML = '<option value="">Select Season</option>';
                    seasonsData = {};
                    
                    if (result.Items.length === 0) {
                        seasonSelect.innerHTML = '<option value="">No seasons found</option>';
                        return;
                    }
                    
                    result.Items.forEach(function(season) {
                        seasonsData[season.Id] = season;
                        var opt = document.createElement('option');
                        opt.value = season.Id;
                        opt.textContent = season.Name || ('Season ' + season.IndexNumber);
                        seasonSelect.appendChild(opt);
                    });
                });
            }

            // Load episodes when season is selected
            function onSeasonChange(seasonId) {
                var episodeSelect = document.querySelector('#selectEpisode');
                var btnSelect = document.querySelector('#btnSelectEpisode');
                
                if (!seasonId) {
                    episodeSelect.innerHTML = '<option value="">Select Episode</option>';
                    episodeSelect.disabled = true;
                    btnSelect.disabled = true;
                    return;
                }
                
                episodeSelect.innerHTML = '<option value="">Loading episodes...</option>';
                episodeSelect.disabled = true;
                
                getEpisodes(seasonId).then(function(result) {
                    episodeSelect.innerHTML = '<option value="">Select Episode</option>';
                    episodeSelect.disabled = false;
                    episodesData = {};
                    
                    if (result.Items.length === 0) {
                        episodeSelect.innerHTML = '<option value="">No episodes found</option>';
                        episodeSelect.disabled = true;
                        return;
                    }
                    
                    result.Items.forEach(function(episode) {
                        episodesData[episode.Id] = episode;
                        var opt = document.createElement('option');
                        opt.value = episode.Id;
                        var epNum = episode.IndexNumber ? ('E' + episode.IndexNumber + ' - ') : '';
                        opt.textContent = epNum + episode.Name;
                        episodeSelect.appendChild(opt);
                    });
                });
            }

            // Live search with debounce
            function performSearch(query) {
                if (!query || query.length < 2) {
                    document.querySelector('#moviesSection').style.display = 'none';
                    document.querySelector('#seriesSection').style.display = 'none';
                    document.querySelector('#searchSuggestions').style.display = 'none';
                    return;
                }
                
                Promise.all([searchMovies(query), searchSeries(query)]).then(function(results) {
                    var movies = results[0].Items;
                    var series = results[1].Items;
                    
                    renderMovies(movies);
                    renderSeries(series);
                    
                    // Also show quick suggestions dropdown
                    renderSuggestions(movies, series);
                });
            }

            // Render search suggestions dropdown
            function renderSuggestions(movies, series) {
                var container = document.querySelector('#searchSuggestions');
                container.innerHTML = '';
                
                if ((!movies || movies.length === 0) && (!series || series.length === 0)) {
                    container.style.display = 'none';
                    return;
                }
                
                if (movies && movies.length > 0) {
                    var movieHeader = document.createElement('div');
                    movieHeader.style.cssText = 'padding:8px 12px; color:#888; font-size:12px; border-bottom:1px solid #333;';
                    movieHeader.textContent = 'ðŸŽ¬ MOVIES';
                    container.appendChild(movieHeader);
                    
                    movies.slice(0, 5).forEach(function(movie) {
                        var item = document.createElement('div');
                        item.style.cssText = 'padding:10px 12px; cursor:pointer; border-bottom:1px solid #333;';
                        item.textContent = movie.Name + (movie.ProductionYear ? ' (' + movie.ProductionYear + ')' : '');
                        item.addEventListener('mouseenter', function() { this.style.background = '#333'; });
                        item.addEventListener('mouseleave', function() { this.style.background = 'transparent'; });
                        item.addEventListener('click', function() {
                            container.style.display = 'none';
                            selectItem(movie.Id, movie.Name, 'Movie');
                        });
                        container.appendChild(item);
                    });
                }
                
                if (series && series.length > 0) {
                    var seriesHeader = document.createElement('div');
                    seriesHeader.style.cssText = 'padding:8px 12px; color:#888; font-size:12px; border-bottom:1px solid #333;';
                    seriesHeader.textContent = 'ðŸ“º SERIES';
                    container.appendChild(seriesHeader);
                    
                    series.slice(0, 5).forEach(function(show) {
                        var item = document.createElement('div');
                        item.style.cssText = 'padding:10px 12px; cursor:pointer; border-bottom:1px solid #333;';
                        item.textContent = show.Name + (show.ProductionYear ? ' (' + show.ProductionYear + ')' : '');
                        item.addEventListener('mouseenter', function() { this.style.background = '#333'; });
                        item.addEventListener('mouseleave', function() { this.style.background = 'transparent'; });
                        item.addEventListener('click', function() {
                            container.style.display = 'none';
                            selectSeriesItem(show.Id, show.Name);
                        });
                        container.appendChild(item);
                    });
                }
                
                container.style.display = 'block';
            }

            // Page initialization
            document.querySelector('#ParentalSkipperConfigPage').addEventListener('pageshow', function () {
                var page = this;
                var txtSearch = page.querySelector('#txtSearch');
                var selectSeason = page.querySelector('#selectSeason');
                var selectEpisode = page.querySelector('#selectEpisode');
                var btnSelectEpisode = page.querySelector('#btnSelectEpisode');
                var suggestions = page.querySelector('#searchSuggestions');

                // Tab switching
                var tabManage = page.querySelector('#tabManage');
                var tabConfigured = page.querySelector('#tabConfigured');
                var sectionManage = page.querySelector('#manageSection');
                var sectionConfigured = page.querySelector('#configuredSection');

                tabManage.addEventListener('click', function() {
                    tabManage.style.background = '#00a4dc';
                    tabConfigured.style.background = '#333';
                    sectionManage.style.display = 'block';
                    sectionConfigured.style.display = 'none';
                });

                tabConfigured.addEventListener('click', function() {
                    tabConfigured.style.background = '#00a4dc';
                    tabManage.style.background = '#333';
                    sectionManage.style.display = 'none';
                    sectionConfigured.style.display = 'block';
                    renderConfiguredItems();
                });

                // Live search with debounce
                txtSearch.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    var query = this.value;
                    searchTimeout = setTimeout(function() {
                        performSearch(query);
                    }, 300);
                });

                // Hide suggestions when clicking outside
                document.addEventListener('click', function(e) {
                    if (!txtSearch.contains(e.target) && !suggestions.contains(e.target)) {
                        suggestions.style.display = 'none';
                    }
                });

                // Show suggestions on focus if there's a query
                txtSearch.addEventListener('focus', function() {
                    if (this.value.length >= 2) {
                        performSearch(this.value);
                    }
                });

                // Season dropdown change
                selectSeason.addEventListener('change', function() {
                    onSeasonChange(this.value);
                });

                // Episode dropdown change
                selectEpisode.addEventListener('change', function() {
                    btnSelectEpisode.disabled = !this.value;
                });

                // Select episode button
                btnSelectEpisode.addEventListener('click', function() {
                    var episodeId = selectEpisode.value;
                    if (episodeId && episodesData[episodeId]) {
                        var episode = episodesData[episodeId];
                        var seasonName = seasonsData[selectSeason.value] ? seasonsData[selectSeason.value].Name : '';
                        var fullName = seasonName + ' - ' + episode.Name;
                        selectItem(episodeId, fullName, 'Episode');
                    }
                });

                // Add segment button
                page.querySelector('#btnAddSegment').addEventListener('click', function () {
                    var itemId = page.querySelector('#selectedItemId').value;
                    var startStr = page.querySelector('#txtStart').value;
                    var endStr = page.querySelector('#txtEnd').value;
                    var reason = page.querySelector('#txtReason').value;
                    
                    if (!itemId) {
                        alert('Please select a movie or episode first.');
                        return;
                    }

                    if (!startStr || !endStr) {
                        alert('Please enter both Start and End times in HH:MM:SS format.');
                        return;
                    }

                    var startSeconds = timeToSeconds(startStr);
                    var endSeconds = timeToSeconds(endStr);

                    if (startSeconds === null) {
                        alert('Invalid Start time format. Use HH:MM:SS (e.g., 00:15:30).');
                        return;
                    }

                    if (endSeconds === null) {
                        alert('Invalid End time format. Use HH:MM:SS (e.g., 00:16:45).');
                        return;
                    }

                    if (startSeconds >= endSeconds) {
                        alert('Start time must be less than End time.');
                        return;
                    }

                    addSegment(itemId, startSeconds, endSeconds, reason).then(function() {
                        loadSegments(itemId).then(renderSegments);
                        page.querySelector('#txtStart').value = '';
                        page.querySelector('#txtEnd').value = '';
                        page.querySelector('#txtReason').value = '';
                    }).catch(function(err) {
                        console.error('Error adding segment:', err);
                        alert('Error adding segment. Please check console for details.');
                    });
                });
            });
        })();
    </script>
</div>
